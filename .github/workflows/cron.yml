name: Scheduled Cron Jobs

on:
  schedule:
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 6ì‹œ, ì •ì˜¤, ì˜¤í›„ 6ì‹œ, ìì •ì— ì‹¤í–‰
    # UTC ê¸°ì¤€: 21:00, 03:00, 09:00, 15:00
    - cron: '0 21,3,9,15 * * *'  # UTC ì‹œê°„ ê¸°ì¤€
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  data-collection:
    name: Data Collection Job
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run data collection
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          GOOGLE_PLACES_KEY: ${{ secrets.GOOGLE_PLACES_KEY }}
          KAKAO_API_KEY: ${{ secrets.KAKAO_API_KEY }}
          INTERNAL_TOKEN: ${{ secrets.INTERNAL_TOKEN }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://dogwhere.vercel.app' }}
        run: |
          # ë°ì´í„° ìˆ˜ì§‘ API í˜¸ì¶œ
          curl -X POST "${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://dogwhere.vercel.app' }}/api/jobs/simple-collect" \
            -H "Authorization: Bearer ${{ secrets.INTERNAL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"region": {"sido": "ì„œìš¸íŠ¹ë³„ì‹œ"}, "sources": ["google", "kakao"]}' \
            --fail --show-error --max-time 1800

      - name: Update statistics
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          INTERNAL_TOKEN: ${{ secrets.INTERNAL_TOKEN }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://dogwhere.vercel.app' }}
        run: |
          # í†µê³„ ì—…ë°ì´íŠ¸ API í˜¸ì¶œ (ìˆëŠ” ê²½ìš°)
          curl -X POST "${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://dogwhere.vercel.app' }}/api/jobs/update-stats" \
            -H "Authorization: Bearer ${{ secrets.INTERNAL_TOKEN }}" \
            -H "Content-Type: application/json" \
            --fail --show-error --max-time 300 || echo "Statistics update endpoint not available"

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Cron Job Failed: Data Collection',
              body: `The scheduled data collection job failed at ${new Date().toISOString()}\n\nCheck the workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              labels: ['bug', 'cron']
            })

  cleanup:
    name: Cleanup Job
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run cleanup tasks
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          INTERNAL_TOKEN: ${{ secrets.INTERNAL_TOKEN }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://dogwhere.vercel.app' }}
        run: |
          # ì˜¤ë˜ëœ ë°ì´í„° ì •ë¦¬ (ì˜ˆ: 30ì¼ ì´ìƒ ëœ ë¯¸ê²€ì¦ ì¥ì†Œ)
          echo "Running cleanup tasks..."
          # ì‹¤ì œ ì •ë¦¬ ë¡œì§ì€ API ì—”ë“œí¬ì¸íŠ¸ë¡œ êµ¬í˜„í•˜ê±°ë‚˜ ìŠ¤í¬ë¦½íŠ¸ë¡œ ì‹¤í–‰

