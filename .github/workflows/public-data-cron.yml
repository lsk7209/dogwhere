name: Public Data Collection & Regeneration

on:
  schedule:
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ìì •ì— ë°ì´í„° ìˆ˜ì§‘
    - cron: '0 15 * * *'  # UTC 15:00 = KST 00:00
    # ë§¤ì‹œê°„ ì¬ìƒì„± ë° ë°œí–‰ (ë‚´ë¶€ ë¡œì§ì—ì„œ ì„¤ì •ëœ ê°„ê²© ì²´í¬)
    - cron: '0 * * * *'  # ë§¤ ì •ì‹œ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  collect:
    name: Collect Public Data
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Collect public data (incremental)
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          INTERNAL_TOKEN: ${{ secrets.INTERNAL_TOKEN }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://dogwhere.vercel.app' }}
          # ê³µê³µë°ì´í„°í¬í„¸ API í‚¤ (ì˜ˆì‹œ)
          PUBLIC_DATA_API_KEY: ${{ secrets.PUBLIC_DATA_API_KEY }}
        run: |
          # ê³µê³µë°ì´í„° ì¦ë¶„ ìˆ˜ì§‘ API í˜¸ì¶œ (ë§¤ì¼ ìì •)
          # incremental: trueë¡œ ì„¤ì •í•˜ì—¬ ìƒˆë¡œ ì¶”ê°€ëœ ë°ì´í„°ë§Œ ìˆ˜ì§‘
          curl -X POST "${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://dogwhere.vercel.app' }}/api/public-data/collect" \
            -H "Authorization: Bearer ${{ secrets.INTERNAL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "source": "data.go.kr",
              "incremental": true,
              "config": {
                "apiKey": "${{ secrets.PUBLIC_DATA_API_KEY }}",
                "baseUrl": "https://apis.data.go.kr",
                "endpoint": "/B551011/KorService1/searchKeyword",
                "params": {
                  "keyword": "ê°•ì•„ì§€ ë™ë°˜"
                }
              }
            }' \
            --fail --show-error --max-time 1800

  regenerate:
    name: Regenerate Content with Gemini
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: collect
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Add to regeneration queue
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          INTERNAL_TOKEN: ${{ secrets.INTERNAL_TOKEN }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://dogwhere.vercel.app' }}
        run: |
          # ì¬ìƒì„±ëœ ì»¨í…ì¸ ê°€ ì—†ëŠ” ë°ì´í„°ë§Œ íì— ì¶”ê°€
          curl -X POST "${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://dogwhere.vercel.app' }}/api/public-data/queue" \
            -H "Authorization: Bearer ${{ secrets.INTERNAL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"batch": true, "limit": 10}' \
            --fail --show-error --max-time 300

      - name: Regenerate content
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          INTERNAL_TOKEN: ${{ secrets.INTERNAL_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://dogwhere.vercel.app' }}
        run: |
          # ë°°ì¹˜ ì¬ìƒì„± (ìµœëŒ€ 10ê°œ)
          # ì¬ìƒì„± ì™„ë£Œ ì‹œ ì¦‰ì‹œ ì‚¬ì´íŠ¸ë§µì— í¬í•¨ (ê¸°ì¡´ í˜ì´ì§€ ì—…ë°ì´íŠ¸ ê°œë…)
          curl -X POST "${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://dogwhere.vercel.app' }}/api/public-data/regenerate" \
            -H "Authorization: Bearer ${{ secrets.INTERNAL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"batch": true}' \
            --fail --show-error --max-time 3600

      - name: Generate AI Blog Post
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          INTERNAL_TOKEN: ${{ secrets.INTERNAL_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://dogwhere.vercel.app' }}
        run: |
          # ì‹ ê·œ AI ë¸”ë¡œê·¸ ìƒì„± í˜¸ì¶œ (ë‚´ë¶€ ê°„ê²© ì²´í¬ ë¡œì§ í¬í•¨)
          curl -X POST "${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://dogwhere.vercel.app' }}/api/admin/blog/generate" \
            -H "Authorization: Bearer ${{ secrets.INTERNAL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{}' \
            --fail --show-error --max-time 300

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Public Data Job Failed',
              body: `The public data collection/regeneration job failed at ${new Date().toISOString()}\n\nCheck the workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              labels: ['bug', 'public-data']
            })

